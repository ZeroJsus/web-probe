name: Rollup Frontend CI/CD to Cloudflare Pages

on:
  push:
    branches:
      - main  # ä»…åœ¨ä»£ç æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # ç¯å¢ƒå˜é‡ï¼šå®šä¹‰æ„å»ºäº§ç‰©ç›®å½•å’Œ Node ç‰ˆæœ¬
    env:
      NODE_VERSION: '18' # å»ºè®®ä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬
      BUILD_OUTPUT_DIR: 'dist' # è¯·æ ¹æ®æ‚¨çš„ rollup.config.js ç¡®è®¤
      CF_PROJECT_NAME: 'web-probe' # æ›¿æ¢ä¸ºåœ¨ Cloudflare Pages ä¸Šåˆ›å»ºçš„é¡¹ç›®å

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: âš™ï¸ Checkout repository
        uses: actions/checkout@v4
        
      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸŸ¢ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # æ²¡æœ‰ yarn.lock ç­‰ç¼“å­˜æ–‡ä»¶ ä¸éœ€è¦æœ‰è¿™ä¸ªè®¾ç½®
          # cache: 'npm' # å¯ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…
          
      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: npm install

      # 4. Rollup æ„å»º
      - name: ğŸ”¨ Build with Rollup
        run: npm run build

        # æ­¥éª¤ 4.5: è¿è¡Œæµ‹è¯•
      - name: ğŸ§ª Run Tests (Jest/Vitest/Mocha)
        run: npm test # ç¡®ä¿æ‚¨çš„ package.json ä¸­æœ‰æµ‹è¯•è„šæœ¬
        
      # 5. (å¯é€‰) éƒ¨ç½²å‰æ£€æŸ¥ - ç¡®ä¿æ„å»ºäº§ç‰©å­˜åœ¨
      - name: ğŸ‘€ Verify Build Artifacts
        run: |
          if [ ! -d ${{ env.BUILD_OUTPUT_DIR }} ]; then
            echo "Error: Build output directory (${{ env.BUILD_OUTPUT_DIR }}) not found after build."
            exit 1
          fi
          
      # 6. éƒ¨ç½²åˆ° Cloudflare Pages
      - name: ğŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          # accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} # éå¿…éœ€ï¼Œä½†æ¨èè®¾ç½®
          projectName: ${{ env.CF_PROJECT_NAME }}
          directory: ${{ env.BUILD_OUTPUT_DIR }} # ä½¿ç”¨å‰é¢å®šä¹‰çš„ç¯å¢ƒå˜é‡
          # éƒ¨ç½²æ“ä½œä¸åº”è¯¥å†æ¬¡æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨æ­¥éª¤ 4 ä¸­å®Œæˆäº†ã€‚
